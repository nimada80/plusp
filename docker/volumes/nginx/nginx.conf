# Basic reverse proxy config for Kong
# You can expand this as needed for SSL, Studio, etc.

worker_processes 1;
events { worker_connections 1024; }
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    upstream kong_upstream {
        server kong:8000;
    }
    
    # Proxy backend (Django)
    upstream django_backend {
        server 172.21.0.15:8010;  # آدرس IP برای plusptt-backend
    }
    
    # Supabase Studio
    upstream studio_backend {
        server supabase-studio:3000;
    }
    
    server {
        listen 80;

        # ریدایرکت دستی /project/ به /project/default 
        location = /project {
            return 301 $scheme://$host/project/default;
        }

        location = /project/ {
            return 301 $scheme://$host/project/default;
        }

        # استودیو - پنل مدیریتی
        location /project/ {
            proxy_pass http://studio_backend/project/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header Origin $http_origin;
            proxy_http_version 1.1;
            proxy_hide_header X-Frame-Options;
            proxy_set_header X-Forwarded-Ssl on;
            allow all;
        }

        # مسیر _next برای فایل‌های استاتیک Next.js - ارسال به supabase-studio
        location /_next/ {
            proxy_pass http://studio_backend/_next/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header Origin $http_origin;
            allow all;
        }

        # فایل‌های لوگو و تصاویر استودیو
        location /img/ {
            proxy_pass http://studio_backend/img/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header Origin $http_origin;
            allow all;
        }

        # فایل‌های monaco-editor
        location /monaco-editor/ {
            proxy_pass http://studio_backend/monaco-editor/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header Origin $http_origin;
            allow all;
        }

        # Proxy requests to frontend - فقط برای مسیرهای اصلی
        location = / {
            proxy_pass http://172.21.0.17:80;  # آدرس IP برای plusptt-frontend
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            allow all;
        }
        
        # فایل‌های استاتیک frontend
        location ~ ^/(static|favicon.ico|logo192.png|logo512.png|manifest.json|robots.txt|env.js) {
            proxy_pass http://172.21.0.17:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            allow all;
        }

        # API های سوپابیس استودیو - قبل از API های دیگر قرار گیرند
        location = /api/cli-release-version {
            proxy_pass http://studio_backend/api/cli-release-version;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header Origin $http_origin;
            allow all;
        }

        # API های پلتفرم استودیو
        location /api/platform/ {
            proxy_pass http://studio_backend/api/platform/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header Origin $http_origin;
            allow all;
        }

        # Handle API auth requests directly to Django backend
        location /api/auth/ {
            proxy_pass http://django_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header Origin $http_origin;
            
            # Handle OPTIONS preflight requests
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' 'http://localhost:3010' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-csrftoken' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 1728000 always;
                add_header 'Content-Type' 'text/plain; charset=utf-8' always;
                add_header 'Content-Length' 0 always;
                return 204;
            }
            
            # Remove CORS headers from normal responses - let Django handle these
        }
        
        # Handle all other API requests to Django backend
        location /api/ {
            proxy_pass http://django_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header Origin $http_origin;
            
            # Handle OPTIONS preflight requests
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' 'http://localhost:3010' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-csrftoken' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 1728000 always;
                add_header 'Content-Type' 'text/plain; charset=utf-8' always;
                add_header 'Content-Length' 0 always;
                return 204;
            }
            
            # Remove CORS headers from normal responses - let Django handle these
        }

        # Proxy Supabase-related requests to Kong
        location ~ ^/(rest|auth|storage|realtime|functions|graphql)/ {
            proxy_pass http://kong_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Serve static files directly
        location /backend/static/ {
            alias /app/static/;
            expires 30d;
            add_header Cache-Control "public, max-age=2592000";
            allow all;
        }

        # Serve media files directly (if used)
        location /backend/media/ {
            alias /app/media/;
            expires 30d;
            add_header Cache-Control "public, max-age=2592000";
            allow all;
        }

        # Proxy /backend/ to Django backend
        location /backend/ {
            proxy_pass http://django_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header Origin $http_origin;
        }
        
        # برای مسیرهای دیگر، به سمت backend ریدایرکت شوند
        location / {
            proxy_pass http://django_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header Origin $http_origin;
        }
    }
}
